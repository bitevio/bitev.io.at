import{bx as A,m as S,l as V,o as Y,bA as Q,aq as _,aF as B,as as m,f as n,ax as L,ay as P,aA as E,B as q,V as y,aE as F,aC as U,ar as x,at as t,au as $,E as k,aw as D,u as j,aD as O,r as K,bv as J,bF as G}from"./index.4168a33c.js";import{Q as X}from"./QPageSticky.aa0e1699.js";import{Q as R,a as Z,b as T}from"./QTabPanels.dfdb6bd1.js";import{Q as ee}from"./QTabs.f8ded2f9.js";import{Q as te}from"./QPage.f76db70e.js";import{F as M,i as z,B as oe,r as ae,D as ne,g as ie,a as se,b as le,e as re,f as I,h as ce,Q as b,c as de,d as ue,T as me,j as fe,k as pe,n as C,L as he}from"./FaceMatcher.f647907e.js";import{h as w}from"./moment.9709ab41.js";import{u as N}from"./use-dialog-plugin-component.ad2aa151.js";import"./touch.70a9dd44.js";import"./rtl.b51694b1.js";function _e(l,s){var u=Array.isArray(s)?s:[s];u.forEach(function(e){var r=e instanceof M?e.score:z(e)?e.detection.score:void 0,a=e instanceof M?e.box:z(e)?e.detection.box:new oe(e),p=r?""+ae(r):void 0;new ne(a,{label:p}).draw(l)})}function ge(l,s,u){u===void 0&&(u=!1);var e=u?ie(s):s,r=e.width,a=e.height;return l.width=r,l.height=a,{width:r,height:a}}function W(l,s){var u=new se(s.width,s.height),e=u.width,r=u.height;if(e<=0||r<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:e,height:r}));if(Array.isArray(l))return l.map(function(g){return W(g,{width:e,height:r})});if(le(l)){var a=l.detection.forSize(e,r),p=l.unshiftedLandmarks.forSize(a.box.width,a.box.height);return re(I(l,a),p)}return z(l)?I(l,l.detection.forSize(e,r)):l instanceof ce||l instanceof M?l.forSize(e,r):l}const ve={key:0},be={class:"q-pt-lg q-pa-lg"},ye={class:"q-gutter-sm"},xe={key:1,class:"fit"},we={style:{"font-size":"18px"}},ke={key:0},De=t("br",null,null,-1),Ce={key:1},$e=t("br",null,null,-1),Qe=t("br",null,null,-1),qe=t("span",{class:"text-caption"}," Heure de d\xE9part : ",-1),Fe={__name:"result",props:{result:"",action:{},function_code:{}},setup(l){const s=l,{dialogRef:u,onDialogOK:e,onDialogHide:r}=N();A();const a=S({item:{},loading:!0});V(()=>{}),Y(()=>{p()});async function p(){var i;a.loading=!0;var g=s.result.split("|")[2];{var h=await Q.createOne("controls",{data:{action:s.action,function_code:{connect:{id:(i=s==null?void 0:s.function_code)==null?void 0:i.id}},datetime:w().format("YYYY-MM-YYTHH:mm"),employee:{connect:{id:g}}},include:{employee:!0}}).then(o=>o).catch(o=>null);console.log(h),h&&(a.item=h,setTimeout(()=>{r()},5e3))}a.loading=!1}return(g,h)=>(_(),B(O,{ref_key:"dialogRef",ref:u,maximized:"",class:"text-center"},{default:m(()=>[n(L,{class:"bg-white text-black"},{default:m(()=>[n(P,null,{default:m(()=>[n(E),q(n(y,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[F]])]),_:1}),n(U,{style:{height:"80vh"}},{default:m(()=>{var i,o,c,d,v;return[a.loading?(_(),x("div",ve,[t("div",be,[t("div",ye,[n(b,{type:"QAvatar"}),n(b,{type:"text"}),n(b,{type:"text"}),n(b,{type:"QInput"})])])])):(_(),x("div",xe,[t("div",null,[t("div",we,[n($,{color:"green",size:"xl",name:"mdi-check-circle"}),t("p",null,[k(" Hello ! "),t("b",null,D((o=(i=a.item)==null?void 0:i.employee)==null?void 0:o.first_name)+" "+D((d=(c=a.item)==null?void 0:c.employee)==null?void 0:d.last_name),1)]),t("div",null,[a.item.action.value=="arrival"?(_(),x("p",ke,[n($,{size:"lg",color:"green",name:"mdi-arrow-up"}),k(),De,k(" Vous avez point\xE9 pr\xE9sent \xE0 ")])):(_(),x("p",Ce,[n($,{size:"lg",color:"red",name:"mdi-arrow-down"}),k(),$e,k(" A bientot ! ...... "),Qe,qe]))]),t("p",null,D(j(w)((v=a==null?void 0:a.item)==null?void 0:v.createdAt).format("HH:mm:ss")),1),t("p",null,[q(n(y,{outline:"",icon:"mdi-arrow-left",label:"Retour "},null,512),[[F]])])])])]))]}),_:1})]),_:1})]),_:1},512))}},Me={key:0},ze={class:"q-pt-lg q-pa-lg"},Ae={class:"q-gutter-sm"},Se={key:1,class:"fit"},Ve=t("div",{class:"cadran-ui"},null,-1),Ye=t("div",{id:"section",class:"flex fit flex-center"},[t("video",{class:"fit video-full",id:"video",style:{width:"100%"},autoplay:""})],-1),Be=[Ve,Ye],He={__name:"check",props:{descriptors:[],function_code:null,action:null},setup(l){const s=l,{dialogRef:u,onDialogOK:e}=N(),r=A(),a=S({descriptors:[],loading:!1,detect:null,stream:null});K(null),V(()=>{p()}),Y(async()=>{h()});function p(){a.stream&&a.stream.getTracks().forEach(function(i){i.stop()}),a.detect&&clearInterval(a.detect),a.detect=null}async function g(i=[]){if(!i.length)return;const o=.35,d=new pe(s.descriptors,o).findBestMatch(i);a.is=d.label,d.label!=="unknown"&&d.label&&(p(),e(!0),r.dialog({component:Fe,componentProps:{result:d.label,action:s.action,function_code:s.function_code}}))}function h(){navigator.mediaDevices.getUserMedia({video:{facingMode:"user",echoCancellation:!0,width:{width:{min:1024,ideal:1280,max:1920},height:{min:776,ideal:720,max:1080}}}}).then(i=>{a.stream=i;var o=document.getElementById("video");o.srcObject=i,o.addEventListener("play",()=>{const c=de(o);document.getElementById("section").append(c);const v={width:o.clientWidth,height:o.clientHeight};ge(c,v),a.detect=setInterval(async()=>{try{const f=await ue(o,new me({scoreThreshold:.5,inputSize:320})).withFaceLandmarks().withFaceDescriptor();if(f){console.log("Detection",f),c.style.visibility="visible";const H=W(f,v);c.getContext("2d").clearRect(0,0,c.width,c.height),_e(c,H),fe(c,H),g(f.descriptor)}else c.style.visibility="hidden",c.getContext("2d").clearRect(0,0,c.width,c.height)}catch(f){console.log(f)}},300),a.detect})}).catch(i=>{console.log(i)})}return(i,o)=>(_(),B(O,{ref_key:"dialogRef",ref:u,"transition-hide":"fade","transition-show":"fade",maximized:"",class:"text-center"},{default:m(()=>[n(L,{class:"bg-moon text-white"},{default:m(()=>[n(P,{style:{"z-index":"9999"},class:"fixed-top bg-black"},{default:m(()=>[n(E),q(n(y,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[F]])]),_:1}),n(U,{style:{height:"100%"}},{default:m(()=>[a.loading?(_(),x("div",Me,[t("div",ze,[t("div",Ae,[n(b,{type:"QAvatar"}),n(b,{type:"text"}),n(b,{type:"text"}),n(b,{type:"QInput"})])])])):(_(),x("div",Se,Be))]),_:1})]),_:1})]),_:1},512))}},Re={class:"q-gutter-sm"},Te={style:{height:"10vh"}},Ie={class:"q-pt-lg text-center text-bold q-pa-lg"},Le={class:"text-h5 text-bold"},Pe=t("br",null,null,-1),Ee={class:"q-pt-lg q-pa-lg"},Ue={class:"text-center"},Oe=t("div",{class:"text-h4 text-green text-bold"},"Arriv\xE9e",-1),Ne=t("p",null,"Pointer votre arrivee",-1),We={class:"q-pt-lg"},je={class:"q-pt-lg q-pa-lg"},Ke={class:"text-center"},Je=t("div",{class:"text-h5 text-bold"},"D\xE9part",-1),Ge=t("p",null,"Renseignez votre d\xE9part pour toute sortie avec le motif si possible",-1),Xe={class:"q-pt-md"},Ze={class:"q-pt-lg"},dt={__name:"index",setup(l){const s=A(),u=J(),e=S({tab:"arrival",codes:[],controls:[],timespeed:null,date:{day:w().format("ddd DD ,MMM YYYY"),hours:w().format("HH:mm:ss")},entry:{action:"arrival",code_function:null}});Y(async()=>{await r(),p(),a()});async function r(){s.loading.show({spinnerSize:20}),await Promise.all([C.ssdMobilenetv1.loadFromUri("/models"),C.tinyFaceDetector.loadFromUri("/models"),C.faceLandmark68Net.loadFromUri("/models"),C.faceRecognitionNet.loadFromUri("/models")]).catch(i=>{console.log("this error",i)}).then(i=>{console.log(i)}),s.loading.hide()}async function a(){u.descriptors.length||s.loading.show({customClass:"bg-black",backgroundColor:"black",message:"Chargement des donn\xE9es en cours ...",spinnerSize:20}),e.descriptors=await Q.endpoint("/private/faceapi/descriptors").then(i=>i).catch(i=>[]),console.log("descriptors",e.descriptors),u.updateDescriptor(e.descriptors),s.loading.hide()}V(()=>{e.timespeed&&clearInterval(e.timespeed)}),e.timespeed=setInterval(()=>{e.date={day:w().format("ddd DD ,MMM YYYY"),hours:w().format("HH:mm:ss")}},1e3);async function p(){e.codes=await Q.findMany("function_codes").catch(i=>[]),g()}function g(){e.codes.map(i=>{i.code==0&&(e.entry.code_function=i)})}function h(){var i=[];u.descriptors.filter(o=>{i.push(new he(o.label,[new Float32Array(o.descriptors[0])]))}),s.dialog({component:He,componentProps:{descriptors:i||[],function_code:e.tab=="arrival"?null:e.entry.code_function,action:e.tab=="arrival"?{label:"Arriv\xE9e",value:"arrival"}:{label:"D\xE9part",value:"departure"}}})}return(i,o)=>{const c=G("q-smart-select");return _(),B(te,{class:"bg-white"},{default:m(()=>[n(X,{offset:[20,20],position:"bottom"},{default:m(()=>[t("div",Re,[n(y,{to:"/controls/users",round:"",icon:"mdi-account-group",onClick:o[0]||(o[0]=d=>a())}),n(y,{color:"primary","fab-mini":"",icon:"mdi-sync",onClick:o[1]||(o[1]=d=>a())})])]),_:1}),t("div",null,[t("div",null,[t("div",Te,[t("div",Ie,[t("div",Le,D(e.date.day),1),t("span",null,D(e.date.hours),1)])])]),Pe,n(ee,{"indicator-color":"black",modelValue:e.tab,"onUpdate:modelValue":o[2]||(o[2]=d=>e.tab=d),center:"",class:"fit q-pt-md"},{default:m(()=>[n(R,{class:"bg-positive text-white",name:"arrival",label:"Arriv\xE9"}),n(R,{name:"departure",class:"bg-red text-white",label:"D\xE9part"})]),_:1},8,["modelValue"]),n(Z,{animated:"",modelValue:e.tab,"onUpdate:modelValue":o[7]||(o[7]=d=>e.tab=d)},{default:m(()=>[n(T,{name:"arrival"},{default:m(()=>[t("div",null,[t("div",Ee,[t("div",Ue,[Oe,Ne,t("div",We,[n(y,{rounded:"",outline:"",class:"fit q-pa-md text-black text-bold",icon:"las la-door-open",color:"green",onClick:o[3]||(o[3]=d=>h()),label:"D\xE9marrer"})])])])])]),_:1}),n(T,{name:"departure"},{default:m(()=>{var d,v;return[t("div",je,[t("div",Ke,[Je,Ge,t("div",Xe,[n(c,{title:"Motif de sortie",onOnChange:o[4]||(o[4]=f=>e.entry.code_function=f),selected:(d=e.entry.code_function)==null?void 0:d.id,modelValue:e.entry.code_function,"onUpdate:modelValue":o[5]||(o[5]=f=>e.entry.code_function=f),options:e.codes,prependColor:(v=e.entry.code_function)==null?void 0:v.colour,"option-label":"name","option-value":"id","option-key":"id",label:"Motif de d\xE9part",filled:""},null,8,["selected","modelValue","options","prependColor"])]),t("div",Ze,[n(y,{class:"fit",icon:"las la-sign-in-alt",color:"red",label:"D\xE9marrer",onClick:o[6]||(o[6]=f=>h())})])])])]}),_:1})]),_:1},8,["modelValue"])])]),_:1})}}};export{dt as default};
