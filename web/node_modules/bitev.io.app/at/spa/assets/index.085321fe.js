import{bx as A,m as S,l as V,o as Y,bA as Q,aq as g,aF as B,as as f,f as o,ax as P,ay as E,aA as U,B as q,V as b,aE as F,aC as O,ar as x,at as t,au as C,E as k,aw as D,u as K,aD as N,r as J,bv as G,bF as X}from"./index.fab70866.js";import{Q as Z}from"./QPageSticky.2c42b782.js";import{Q as R,a as ee,b as T}from"./QTabPanels.048a3863.js";import{Q as te}from"./QTabs.ae5e8df5.js";import{Q as oe}from"./QPage.0d4ce3e5.js";import{F as M,i as z,B as ae,r as ne,D as ie,g as se,a as le,b as re,e as ce,f as L,h as de,Q as v,n as $,c as ue,d as me,T as fe,j as pe,k as he,L as _e}from"./FaceMatcher.419f25d4.js";import{h as w}from"./moment.9709ab41.js";import{u as W}from"./use-dialog-plugin-component.902afc34.js";import"./touch.70a9dd44.js";import"./rtl.b51694b1.js";function ge(i,s){var m=Array.isArray(s)?s:[s];m.forEach(function(e){var l=e instanceof M?e.score:z(e)?e.detection.score:void 0,a=e instanceof M?e.box:z(e)?e.detection.box:new ae(e),_=l?""+ne(l):void 0;new ie(a,{label:_}).draw(i)})}function ve(i,s,m){m===void 0&&(m=!1);var e=m?se(s):s,l=e.width,a=e.height;return i.width=l,i.height=a,{width:l,height:a}}function j(i,s){var m=new le(s.width,s.height),e=m.width,l=m.height;if(e<=0||l<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:e,height:l}));if(Array.isArray(i))return i.map(function(h){return j(h,{width:e,height:l})});if(re(i)){var a=i.detection.forSize(e,l),_=i.unshiftedLandmarks.forSize(a.box.width,a.box.height);return ce(L(i,a),_)}return z(i)?L(i,i.detection.forSize(e,l)):i instanceof de||i instanceof M?i.forSize(e,l):i}const be={key:0},ye={class:"q-pt-lg q-pa-lg"},xe={class:"q-gutter-sm"},we={key:1,class:"fit"},ke={style:{"font-size":"18px"}},De={key:0},$e=t("br",null,null,-1),Ce={key:1},Qe=t("br",null,null,-1),qe=t("br",null,null,-1),Fe=t("span",{class:"text-caption"}," Heure de d\xE9part : ",-1),Me={__name:"result",props:{result:"",action:{},function_code:{}},setup(i){const s=i,{dialogRef:m,onDialogOK:e,onDialogHide:l}=W();A();const a=S({item:{},loading:!0});V(()=>{}),Y(()=>{_()});async function _(){var n;a.loading=!0;var h=s.result.split("|")[2];{var u=await Q.createOne("controls",{data:{action:s.action,function_code:{connect:{id:(n=s==null?void 0:s.function_code)==null?void 0:n.id}},datetime:w().format("YYYY-MM-YYTHH:mm"),employee:{connect:{id:h}}},include:{employee:!0}}).then(r=>r).catch(r=>null);console.log(u),u&&(a.item=u,setTimeout(()=>{l()},5e3))}a.loading=!1}return(h,u)=>(g(),B(N,{ref_key:"dialogRef",ref:m,maximized:"",class:"text-center"},{default:f(()=>[o(P,{class:"bg-white text-black"},{default:f(()=>[o(E,null,{default:f(()=>[o(U),q(o(b,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[F]])]),_:1}),o(O,{style:{height:"80vh"}},{default:f(()=>{var n,r,c,d,p;return[a.loading?(g(),x("div",be,[t("div",ye,[t("div",xe,[o(v,{type:"QAvatar"}),o(v,{type:"text"}),o(v,{type:"text"}),o(v,{type:"QInput"})])])])):(g(),x("div",we,[t("div",null,[t("div",ke,[o(C,{color:"green",size:"xl",name:"mdi-check-circle"}),t("p",null,[k(" Hello ! "),t("b",null,D((r=(n=a.item)==null?void 0:n.employee)==null?void 0:r.first_name)+" "+D((d=(c=a.item)==null?void 0:c.employee)==null?void 0:d.last_name),1)]),t("div",null,[a.item.action.value=="arrival"?(g(),x("p",De,[o(C,{size:"lg",color:"green",name:"mdi-arrow-up"}),k(),$e,k(" Vous avez point\xE9 pr\xE9sent \xE0 ")])):(g(),x("p",Ce,[o(C,{size:"lg",color:"red",name:"mdi-arrow-down"}),k(),Qe,k(" A bientot ! ...... "),qe,Fe]))]),t("p",null,D(K(w)((p=a==null?void 0:a.item)==null?void 0:p.createdAt).format("HH:mm:ss")),1),t("p",null,[q(o(b,{outline:"",icon:"mdi-arrow-left",label:"Retour "},null,512),[[F]])])])])]))]}),_:1})]),_:1})]),_:1},512))}},ze={key:0},Ae={class:"q-pt-lg q-pa-lg"},Se={class:"q-gutter-sm"},Ve={key:1,class:"fit"},Ye=t("div",{class:"cadran-ui"},null,-1),Be=t("div",{id:"section",class:"flex fit flex-center"},[t("video",{class:"fit video-full",id:"video",style:{width:"100%"},autoplay:""})],-1),He=[Ye,Be],Ie={__name:"check",props:{descriptors:[],function_code:null,action:null},setup(i){const s=i,{dialogRef:m,onDialogOK:e}=W(),l=A(),a=S({descriptors:[],loading:!1,detect:null,stream:null});J(null),V(()=>{h()}),Y(async()=>{await _()});async function _(){l.loading.show({spinnerSize:20}),await Promise.all([$.ssdMobilenetv1.loadFromUri("/models"),$.tinyFaceDetector.loadFromUri("/models"),$.faceLandmark68Net.loadFromUri("/models"),$.faceRecognitionNet.loadFromUri("/models")]).catch(r=>{console.log("this error",r)}).then(r=>{console.log(r)}),l.loading.hide(),n()}function h(){a.stream&&a.stream.getTracks().forEach(function(r){r.stop()}),a.detect&&clearInterval(a.detect),a.detect=null}async function u(r=[]){if(!r.length)return;const c=.35,p=new he(s.descriptors,c).findBestMatch(r);a.is=p.label,p.label!=="unknown"&&p.label&&(h(),e(!0),l.dialog({component:Me,componentProps:{result:p.label,action:s.action,function_code:s.function_code}}))}function n(){navigator.mediaDevices.getUserMedia({video:{facingMode:"user",echoCancellation:!0,width:{width:{min:1024,ideal:1280,max:1920},height:{min:776,ideal:720,max:1080}}}}).then(r=>{a.stream=r;var c=document.getElementById("video");c.srcObject=r,c.addEventListener("play",()=>{const d=ue(c);document.getElementById("section").append(d);const H={width:c.clientWidth,height:c.clientHeight};ve(d,H),a.detect=setInterval(async()=>{try{const y=await me(c,new fe({scoreThreshold:.5,inputSize:320})).withFaceLandmarks().withFaceDescriptor();if(y){console.log("Detection",y),d.style.visibility="visible";const I=j(y,H);d.getContext("2d").clearRect(0,0,d.width,d.height),ge(d,I),pe(d,I),u(y.descriptor)}else d.style.visibility="hidden",d.getContext("2d").clearRect(0,0,d.width,d.height)}catch(y){console.log(y)}},300),a.detect})}).catch(r=>{console.log(r)})}return(r,c)=>(g(),B(N,{ref_key:"dialogRef",ref:m,"transition-hide":"fade","transition-show":"fade",maximized:"",class:"text-center"},{default:f(()=>[o(P,{class:"bg-moon text-white"},{default:f(()=>[o(E,{style:{"z-index":"9999"},class:"fixed-top bg-black"},{default:f(()=>[o(U),q(o(b,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[F]])]),_:1}),o(O,{style:{height:"100%"}},{default:f(()=>[a.loading?(g(),x("div",ze,[t("div",Ae,[t("div",Se,[o(v,{type:"QAvatar"}),o(v,{type:"text"}),o(v,{type:"text"}),o(v,{type:"QInput"})])])])):(g(),x("div",Ve,He))]),_:1})]),_:1})]),_:1},512))}},Re={class:"q-gutter-sm"},Te={style:{height:"10vh"}},Le={class:"q-pt-lg text-center text-bold q-pa-lg"},Pe={class:"text-h5 text-bold"},Ee=t("br",null,null,-1),Ue={class:"q-pt-lg q-pa-lg"},Oe={class:"text-center"},Ne=t("div",{class:"text-h4 text-green text-bold"},"Arriv\xE9e",-1),We=t("p",null,"Pointer votre arrivee",-1),je={class:"q-pt-lg"},Ke={class:"q-pt-lg q-pa-lg"},Je={class:"text-center"},Ge=t("div",{class:"text-h5 text-bold"},"D\xE9part",-1),Xe=t("p",null,"Renseignez votre d\xE9part pour toute sortie avec le motif si possible",-1),Ze={class:"q-pt-md"},et={class:"q-pt-lg"},ut={__name:"index",setup(i){const s=A(),m=G(),e=S({tab:"arrival",codes:[],controls:[],timespeed:null,date:{day:w().format("ddd DD ,MMM YYYY"),hours:w().format("HH:mm:ss")},entry:{action:"arrival",code_function:null}});Y(()=>{a(),l()});async function l(){m.descriptors.length||s.loading.show({customClass:"bg-black",backgroundColor:"black",message:"Chargement des donn\xE9es en cours ...",spinnerSize:20}),e.descriptors=await Q.endpoint("/private/faceapi/descriptors").then(u=>u).catch(u=>[]),console.log("descriptors",e.descriptors),m.updateDescriptor(e.descriptors),s.loading.hide()}V(()=>{e.timespeed&&clearInterval(e.timespeed)}),e.timespeed=setInterval(()=>{e.date={day:w().format("ddd DD ,MMM YYYY"),hours:w().format("HH:mm:ss")}},1e3);async function a(){e.codes=await Q.findMany("function_codes").catch(u=>[]),_()}function _(){e.codes.map(u=>{u.code==0&&(e.entry.code_function=u)})}function h(){var u=[];m.descriptors.filter(n=>{u.push(new _e(n.label,[new Float32Array(n.descriptors[0])]))}),s.dialog({component:Ie,componentProps:{descriptors:u||[],function_code:e.tab=="arrival"?null:e.entry.code_function,action:e.tab=="arrival"?{label:"Arriv\xE9e",value:"arrival"}:{label:"D\xE9part",value:"departure"}}})}return(u,n)=>{const r=X("q-smart-select");return g(),B(oe,{class:"bg-white"},{default:f(()=>[o(Z,{offset:[20,20],position:"bottom"},{default:f(()=>[t("div",Re,[o(b,{to:"/controls/users",round:"",icon:"mdi-account-group",onClick:n[0]||(n[0]=c=>l())}),o(b,{color:"primary","fab-mini":"",icon:"mdi-sync",onClick:n[1]||(n[1]=c=>l())})])]),_:1}),t("div",null,[t("div",null,[t("div",Te,[t("div",Le,[t("div",Pe,D(e.date.day),1),t("span",null,D(e.date.hours),1)])])]),Ee,o(te,{"indicator-color":"black",modelValue:e.tab,"onUpdate:modelValue":n[2]||(n[2]=c=>e.tab=c),center:"",class:"fit q-pt-md"},{default:f(()=>[o(R,{class:"bg-positive text-white",name:"arrival",label:"Arriv\xE9"}),o(R,{name:"departure",class:"bg-red text-white",label:"D\xE9part"})]),_:1},8,["modelValue"]),o(ee,{animated:"",modelValue:e.tab,"onUpdate:modelValue":n[7]||(n[7]=c=>e.tab=c)},{default:f(()=>[o(T,{name:"arrival"},{default:f(()=>[t("div",null,[t("div",Ue,[t("div",Oe,[Ne,We,t("div",je,[o(b,{rounded:"",outline:"",class:"fit q-pa-md text-black text-bold",icon:"las la-door-open",color:"green",onClick:n[3]||(n[3]=c=>h()),label:"D\xE9marrer"})])])])])]),_:1}),o(T,{name:"departure"},{default:f(()=>{var c,d;return[t("div",Ke,[t("div",Je,[Ge,Xe,t("div",Ze,[o(r,{title:"Motif de sortie",onOnChange:n[4]||(n[4]=p=>e.entry.code_function=p),selected:(c=e.entry.code_function)==null?void 0:c.id,modelValue:e.entry.code_function,"onUpdate:modelValue":n[5]||(n[5]=p=>e.entry.code_function=p),options:e.codes,prependColor:(d=e.entry.code_function)==null?void 0:d.colour,"option-label":"name","option-value":"id","option-key":"id",label:"Motif de d\xE9part",filled:""},null,8,["selected","modelValue","options","prependColor"])]),t("div",et,[o(b,{class:"fit",icon:"las la-sign-in-alt",color:"red",label:"D\xE9marrer",onClick:n[6]||(n[6]=p=>h())})])])])]}),_:1})]),_:1},8,["modelValue"])])]),_:1})}}};export{ut as default};
