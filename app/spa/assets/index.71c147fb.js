import{bv as j,bx as B,m as Y,l as L,o as R,bA as H,aq as _,aF as q,as as n,f as t,ax as T,ay as K,aA as G,B as M,V as $,aE as S,aC as P,ar as k,at as a,au as C,E as b,aw as F,u as Z,aD as U,r as ee,bF as E,bI as te,aW as A,aU as x}from"./index.4b1fffc4.js";import{Q as oe}from"./QPageSticky.34388a5c.js";import{Q as O,a as ae,b as N}from"./QTabPanels.4df5d093.js";import{Q as ne}from"./QTabs.ef7f50eb.js";import{Q as ie}from"./QPage.74799896.js";import{F as I,i as V,B as se,r as le,D as ce,g as re,a as de,b as ue,e as me,f as W,h as fe,Q as y,n as z,c as pe,d as he,T as _e,j as ve,k as ge,L as be}from"./FaceMatcher.08a40757.js";import{h as D}from"./moment.9709ab41.js";import{u as J}from"./use-dialog-plugin-component.95702551.js";import"./touch.70a9dd44.js";import"./rtl.b51694b1.js";function ye(l,i){var m=Array.isArray(i)?i:[i];m.forEach(function(e){var r=e instanceof I?e.score:V(e)?e.detection.score:void 0,s=e instanceof I?e.box:V(e)?e.detection.box:new se(e),d=r?""+le(r):void 0;new ce(s,{label:d}).draw(l)})}function we(l,i,m){m===void 0&&(m=!1);var e=m?re(i):i,r=e.width,s=e.height;return l.width=r,l.height=s,{width:r,height:s}}function X(l,i){var m=new de(i.width,i.height),e=m.width,r=m.height;if(e<=0||r<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:e,height:r}));if(Array.isArray(l))return l.map(function(g){return X(g,{width:e,height:r})});if(ue(l)){var s=l.detection.forSize(e,r),d=l.unshiftedLandmarks.forSize(s.box.width,s.box.height);return me(W(l,s),d)}return V(l)?W(l,l.detection.forSize(e,r)):l instanceof fe||l instanceof I?l.forSize(e,r):l}const xe={key:0},ke={class:"q-pt-lg q-pa-lg"},De={class:"q-gutter-sm"},$e={key:1,class:"fit"},Ce={style:{"font-size":"18px"}},Qe={key:0},qe=a("br",null,null,-1),Fe={key:1},Me=a("br",null,null,-1),Se=a("br",null,null,-1),ze=a("span",{class:"text-caption"}," Heure de d\xE9part : ",-1),Ae={__name:"result",props:{result:"",action:{},function_code:{}},setup(l){const i=l,{dialogRef:m,onDialogOK:e,onDialogHide:r}=J(),s=j();B();const d=Y({item:{},loading:!0});L(()=>{}),R(()=>{g()});async function g(){var o,p;d.loading=!0;var w=i.result.split("|")[2];{var f=await H.createOne("controls",{data:{action:i.action,function_code:{connect:{id:(o=i==null?void 0:i.function_code)==null?void 0:o.id}},datetime:D().format("YYYY-MM-ddTHH:mm"),employee:{connect:{id:w}},device:{connect:{id:(p=s.device)==null?void 0:p.id}}},include:{employee:!0}}).then(c=>c).catch(c=>null);console.log(f),f&&(d.item=f,setTimeout(()=>{r()},5e3))}d.loading=!1}return(w,f)=>(_(),q(U,{ref_key:"dialogRef",ref:m,maximized:"",class:"text-center"},{default:n(()=>[t(T,{class:"bg-white text-black"},{default:n(()=>[t(K,null,{default:n(()=>[t(G),M(t($,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[S]])]),_:1}),t(P,{style:{height:"80vh"}},{default:n(()=>{var o,p,c,u,v;return[d.loading?(_(),k("div",xe,[a("div",ke,[a("div",De,[t(y,{type:"QAvatar"}),t(y,{type:"text"}),t(y,{type:"text"}),t(y,{type:"QInput"})])])])):(_(),k("div",$e,[a("div",null,[a("div",Ce,[t(C,{color:"green",size:"xl",name:"mdi-check-circle"}),a("p",null,[b(" Hello ! "),a("b",null,F((p=(o=d.item)==null?void 0:o.employee)==null?void 0:p.first_name)+" "+F((u=(c=d.item)==null?void 0:c.employee)==null?void 0:u.last_name),1)]),a("div",null,[d.item.action.value=="arrival"?(_(),k("p",Qe,[t(C,{size:"lg",color:"green",name:"mdi-arrow-up"}),b(),qe,b(" Vous avez point\xE9 pr\xE9sent \xE0 ")])):(_(),k("p",Fe,[t(C,{size:"lg",color:"red",name:"mdi-arrow-down"}),b(),Me,b(" A bientot ! ...... "),Se,ze]))]),a("p",null,F(Z(D)((v=d==null?void 0:d.item)==null?void 0:v.createdAt).format("HH:mm:ss")),1),a("p",null,[M(t($,{outline:"",icon:"mdi-arrow-left",label:"Retour "},null,512),[[S]])])])])]))]}),_:1})]),_:1})]),_:1},512))}},He={key:0},Ie={class:"q-pt-lg q-pa-lg"},Ve={class:"q-gutter-sm"},Be={key:1,class:"fit"},Ye=a("div",{class:"cadran-ui"},null,-1),Le=a("div",{id:"section",class:"flex fit flex-center"},[a("video",{class:"fit video-full",id:"video",style:{width:"100%"},autoplay:""})],-1),Re=[Ye,Le],Te={__name:"check",props:{descriptors:[],function_code:null,action:null},setup(l){const i=l,{dialogRef:m,onDialogOK:e}=J(),r=B(),s=Y({descriptors:[],loading:!1,detect:null,stream:null});ee(null),L(()=>{g()}),R(async()=>{await d()});async function d(){r.loading.show({spinnerSize:20}),await Promise.all([z.ssdMobilenetv1.loadFromUri("/models"),z.tinyFaceDetector.loadFromUri("/models"),z.faceLandmark68Net.loadFromUri("/models"),z.faceRecognitionNet.loadFromUri("/models")]).catch(o=>{console.log("this error",o)}).then(o=>{console.log(o)}),r.loading.hide(),f()}function g(){s.stream&&s.stream.getTracks().forEach(function(o){o.stop()}),s.detect&&clearInterval(s.detect),s.detect=null}async function w(o=[]){if(!o.length)return;const p=.35,u=new ge(i.descriptors,p).findBestMatch(o);s.is=u.label,u.label!=="unknown"&&u.label&&(g(),e(!0),r.dialog({component:Ae,componentProps:{result:u.label,action:i.action,function_code:i.function_code}}))}function f(){navigator.mediaDevices.getUserMedia({video:{facingMode:"user",echoCancellation:!0,width:{width:{min:1024,ideal:1280,max:1920},height:{min:776,ideal:720,max:1080}}}}).then(o=>{s.stream=o;var p=document.getElementById("video");p.srcObject=o,p.addEventListener("play",()=>{const c=pe(p);document.getElementById("section").append(c);const v={width:p.clientWidth,height:p.clientHeight};we(c,v),s.detect=setInterval(async()=>{try{const h=await he(p,new _e({scoreThreshold:.5,inputSize:320})).withFaceLandmarks().withFaceDescriptor();if(h){console.log("Detection",h),c.style.visibility="visible";const Q=X(h,v);c.getContext("2d").clearRect(0,0,c.width,c.height),ye(c,Q),ve(c,Q),w(h.descriptor)}else c.style.visibility="hidden",c.getContext("2d").clearRect(0,0,c.width,c.height)}catch(h){console.log(h)}},300),s.detect})}).catch(o=>{console.log(o)})}return(o,p)=>(_(),q(U,{ref_key:"dialogRef",ref:m,"transition-hide":"fade","transition-show":"fade",maximized:"",class:"text-center"},{default:n(()=>[t(T,{class:"bg-moon text-white"},{default:n(()=>[t(K,{style:{"z-index":"9999"},class:"fixed-top bg-black"},{default:n(()=>[t(G),M(t($,{round:"",dark:"",flat:"",icon:"mdi-close"},null,512),[[S]])]),_:1}),t(P,{style:{height:"100%"}},{default:n(()=>[s.loading?(_(),k("div",He,[a("div",Ie,[a("div",Ve,[t(y,{type:"QAvatar"}),t(y,{type:"text"}),t(y,{type:"text"}),t(y,{type:"QInput"})])])])):(_(),k("div",Be,Re))]),_:1})]),_:1})]),_:1},512))}},Pe={class:"q-gutter-sm"},Ue={style:{height:"10vh"}},Ee={class:"q-pt-lg text-center text-bold q-pa-lg"},Oe={class:"text-h5 text-bold"},Ne=a("br",null,null,-1),We={class:"q-pt-lg q-pa-lg"},je={class:"text-center"},Ke=a("div",{class:"text-h4 text-green text-bold"},"Arriv\xE9e",-1),Ge=a("p",null,"Pointer votre arrivee",-1),Je={class:"q-pt-lg"},Xe={class:"q-pt-lg q-pa-lg"},Ze={class:"text-center"},et=a("div",{class:"text-h5 text-bold"},"D\xE9part",-1),tt=a("p",null,"Renseignez votre d\xE9part pour toute sortie avec le motif si possible",-1),ot={class:"q-pt-md"},at={class:"q-pt-lg"},pt={__name:"index",setup(l){const i=B(),m=j(),e=Y({tab:"arrival",codes:[],controls:[],timespeed:null,date:{day:D().format("ddd DD ,MMM YYYY"),hours:D().format("HH:mm:ss")},entry:{action:"arrival",code_function:null}});R(async()=>{d(),s()});function r(){m.updateAuthDevice({auth:!1,device:{}}),i.notify({message:"D\xE9connection r\xE9uissie"})}async function s(){m.descriptors.length||i.loading.show({customClass:"bg-black",backgroundColor:"black",message:"Chargement des donn\xE9es en cours ...",spinnerSize:20}),e.descriptors=await H.endpoint("/private/faceapi/descriptors").then(f=>f).catch(f=>[]),console.log("descriptors",e.descriptors),m.updateDescriptor(e.descriptors),i.loading.hide()}L(()=>{e.timespeed&&clearInterval(e.timespeed)}),e.timespeed=setInterval(()=>{e.date={day:D().format("ddd DD ,MMM YYYY"),hours:D().format("HH:mm:ss")}},1e3);async function d(){e.codes=await H.findMany("function_codes").catch(f=>[]),g()}function g(){e.codes.map(f=>{f.code==0&&(e.entry.code_function=f)})}function w(){var f=[];m.descriptors.filter(o=>{f.push(new be(o.label,[new Float32Array(o.descriptors[0])]))}),i.dialog({component:Te,componentProps:{descriptors:f||[],function_code:e.tab=="arrival"?null:e.entry.code_function,action:e.tab=="arrival"?{label:"Arriv\xE9e",value:"arrival"}:{label:"D\xE9part",value:"departure"}}})}return(f,o)=>{const p=E("q-smart-reactif"),c=E("q-smart-select");return _(),q(ie,{class:"bg-white"},{default:n(()=>[t(oe,{offset:[20,20],position:"bottom"},{default:n(()=>[a("div",Pe,[t(p,null,{default:n(({active:u,toggle:v,close:h})=>[t($,{onClick:Q=>v(),icon:"mdi-menu"},null,8,["onClick"]),t(U,{"full-width":"",position:"bottom",onHide:h,"model-value":u},{default:n(()=>[t(T,null,{default:n(()=>[t(P,null,{default:n(()=>[t(te,null,{default:n(()=>[t(A,{clickable:"",to:"/controls/users"},{default:n(()=>[t(x,{avatar:""},{default:n(()=>[t(C,{name:"mdi-account-group"})]),_:1}),t(x,null,{default:n(()=>[b(" Gestion des utilisateurs")]),_:1})]),_:1}),M((_(),q(A,{onClick:o[0]||(o[0]=Q=>s()),clickable:""},{default:n(()=>[t(x,{avatar:""},{default:n(()=>[t(C,{name:"mdi-sync"})]),_:1}),t(x,null,{default:n(()=>[b(" Synchroniser")]),_:1})]),_:1})),[[S]]),M((_(),q(A,{onClick:o[1]||(o[1]=Q=>r()),clickable:""},{default:n(()=>[t(x,{avatar:""},{default:n(()=>[t(C,{name:"mdi-power"})]),_:1}),t(x,null,{default:n(()=>[b(" Se d\xE9connecter ")]),_:1})]),_:1})),[[S]])]),_:1})]),_:1})]),_:1})]),_:2},1032,["onHide","model-value"])]),_:1})])]),_:1}),a("div",null,[a("div",null,[a("div",Ue,[a("div",Ee,[a("div",Oe,F(e.date.day),1),a("span",null,F(e.date.hours),1)])])]),Ne,t(ne,{"indicator-color":"black",modelValue:e.tab,"onUpdate:modelValue":o[2]||(o[2]=u=>e.tab=u),center:"",class:"fit q-pt-md"},{default:n(()=>[t(O,{class:"bg-positive text-white",name:"arrival",label:"Arriv\xE9"}),t(O,{name:"departure",class:"bg-red text-white",label:"D\xE9part"})]),_:1},8,["modelValue"]),t(ae,{animated:"",modelValue:e.tab,"onUpdate:modelValue":o[7]||(o[7]=u=>e.tab=u)},{default:n(()=>[t(N,{name:"arrival"},{default:n(()=>[a("div",null,[a("div",We,[a("div",je,[Ke,Ge,a("div",Je,[t($,{rounded:"",outline:"",class:"fit q-pa-md text-black text-bold",icon:"las la-door-open",color:"green",onClick:o[3]||(o[3]=u=>w()),label:"D\xE9marrer"})])])])])]),_:1}),t(N,{name:"departure"},{default:n(()=>{var u,v;return[a("div",Xe,[a("div",Ze,[et,tt,a("div",ot,[t(c,{title:"Motif de sortie",onOnChange:o[4]||(o[4]=h=>e.entry.code_function=h),selected:(u=e.entry.code_function)==null?void 0:u.id,modelValue:e.entry.code_function,"onUpdate:modelValue":o[5]||(o[5]=h=>e.entry.code_function=h),options:e.codes,prependColor:(v=e.entry.code_function)==null?void 0:v.colour,"option-label":"name","option-value":"id","option-key":"id",label:"Motif de d\xE9part",filled:""},null,8,["selected","modelValue","options","prependColor"])]),a("div",at,[t($,{class:"fit",icon:"las la-sign-in-alt",color:"red",label:"D\xE9marrer",onClick:o[6]||(o[6]=h=>w())})])])])]}),_:1})]),_:1},8,["modelValue"])])]),_:1})}}};export{pt as default};
